---
title: "Maps of qc1b"
output: html_notebook
---

################################################################################

# Gráficos

## Mapas da distribuição espacial das informações do produto 3.

### Observações suspeitas

#### Porcentagem

```{r, fig.width=9.3, fig.height=7.25, fig.align='center' }
# dados_summary combinados com info
var1_summary_qc_j <- full_join(var1_summary_qc, var_info, by = "site") %>%
 mutate_if(is.numeric, replace_NA)

estados <- readRDS("../data/estados_sul.rds")

var_plot <- "perc"

var1_gg_tot_qc1b <- gg_bubble(data = var1_summary_qc_j
                     ,z = var_plot
                     ,breaks = c(pretty(var1_summary_qc_j[[var_plot]], n = 6))
                     ,limites = estados
                     ,colors_z = viridis::viridis
                     ,color_fill = "burlywood3"
                     ,z_legend = "Dados suspeitos \n (%)"
                     ,text_color = "gray30"
                     ,point_color = "transparent"
                     ,text_size = 2.6
                     ,point_size = 5
                     ,repel_min_seg_len = 2
                     ,legend.justification = c(0,1) 
                     ,legend.position = c(0.01, 0.99)
                     ,guide_type = "colourbar"
                     ) + labs(title = "QC2")
var1_gg_tot_qc1b
```


#### Total

```{r, fig.width=9.3, fig.height=7.25, fig.align='center' }
var_plot <- "tot"

var1_gg_tot_qc1b <- gg_bubble(data = var1_summary_qc_j
                     ,z = var_plot
                     ,breaks = c(pretty(var1_summary_qc_j[[var_plot]], n = 6))
                     ,limites = estados
                     ,colors_z = viridis::viridis
                     ,color_fill = "burlywood3"
                     ,z_legend = "Dados suspeitos \n (%)"
                     ,text_color = "gray30"
                     ,point_color = "transparent"
                     ,text_size = 2.6
                     ,point_size = 5
                     ,repel_min_seg_len = 2,
                     ,legend.justification = c(0,1) 
                     ,legend.position = c(0.01, 0.99)
                     ,guide_type = "colourbar"
                     ) + labs(title = "QC2")
var1_gg_tot_qc1b
```


### Máximo n° de horas consecutivas suspeitas por EMA

```{r, fig.width=9.3, fig.height=7.25, fig.align='center' }
var_plot <- "n_max"

var1_gg_max_rep_qc2 <- gg_bubble(data = var1_summary_qc_j
                     ,z = var_plot
                     ,breaks = c(pretty(var1_summary_qc_j[[var_plot]], n = 11))
                     ,limites = estados
                     ,colors_z = viridis::viridis
                     ,color_fill = "burlywood3"
                     ,z_legend = "Maior sequência \n de obs. suspeitas (%)"
                     ,text_color = "gray30"
                     ,point_color = "transparent"
                     ,text_size = 2.6
                     ,point_size = 5
                     ,repel_min_seg_len = 2
                     ,legend.justification = c(0,1) 
                     ,legend.position = c(0.01, 0.99)
                     ,guide_type = "colourbar"
                     ) + labs(title = "QC2")
var1_gg_max_rep_qc2
```

## Histograma de observações suspeitas por n° de horas repetidas consecutivas (produto 2)

```{r}
var1_ggp_qc2_hist <- ggplot(data = var1_meta_qc) +
  geom_histogram(aes(x = n, y = ..count../sum(..count..) * 100), stat = "count") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 7), expand = c(0.01,0)) +
  labs(x = "Horas suspeitas consecutivas",
       y = "Frequência de ocorrência(%)") 
var1_ggp_qc2_hist 
#-------------------------------------------------------------------------------


ggplot(data = var1_meta_qc) +
  geom_histogram(aes(x = n), stat = "count") +
  #scale_y_continuous(labels = comma)
  #scale_y_log10(breaks = c(200000, 10000, 2500, 1000, 500, 100, 50, 10,1),
  #              labels = point) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 7), expand = c(0.01,0)) +
  labs(x = "Horas repetidas consecutivas",
       y = "Frequência de ocorrência absoluta")
```


## Visão geral da distribuição das observações suspeitas (produto 1) no tempo e nas EMAs

```{r, fig.height=14, fig.asp=1.2}
sites_o <- var1_summary_qc_j$site[order(var1_summary_qc_j$tot)]
sites_o

data_image <- var1_data_qc %>%
  mutate(site = ordered(site, levels = sites_o))

var1_ggp_image <- ggplot(data = data_image,
                        aes(x = date, y = site)) +
  geom_point(aes(colour = factor(tavg_qc1b)), shape = 15, size = 2.6) + 
  labs(x = "Ano", y = "EMA") +
  scale_x_datetime(expand = c(0, 0), date_breaks = "1 year", date_labels = "%Y") +
    scale_colour_manual("rótulo",
                         values = c("1" = "black", 
                                    "0" = "yellow")) +
  theme_bw() +
  theme(text = element_text(size=10)
        ) #+ guides()
var1_ggp_image
```



### Número de observações suspeitas por EMA

```{r, fig.height=14, fig.asp=1.2}
#meta_qc
var1_data_bar_qc2 <- var1_summary_qc_j %>% 
  #right_join(., select(meta_qc, site, value), by = "site") %>%
  mutate(site = ordered(site, levels = sites_o)) %>% 
  filter(tot > 0)
var1_data_bar_qc2

var1_ggp_tot_qc2 <- ggplot(data = var1_data_bar_qc2) +
  geom_bar(aes(x = site, y = tot
               #, fill = value
               ),
  #geom_bar(aes(x = site, y = perc),
           stat = "identity",
           width = 0.8) +
  
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10), 
                     expand = c(0.01,0)
                     #, labels = point
                     ) +
  coord_flip() 
var1_ggp_tot_qc2
# fazer gráfico com num de casos por mês (evolução temporal)
```
